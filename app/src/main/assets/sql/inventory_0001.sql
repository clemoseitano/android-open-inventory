BEGIN TRANSACTION;
CREATE TABLE IF NOT EXISTS customers ( id TEXT PRIMARY KEY DEFAULT (ABS(RANDOM()) % 1000000000000 + 100000000000), name TEXT, contact TEXT, payment_method TEXT, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP, deleted_at DATETIME DEFAULT NULL);
CREATE TABLE IF NOT EXISTS out_of_stock_log ( id TEXT PRIMARY KEY DEFAULT (ABS(RANDOM()) % 1000000000000 + 100000000000),     product_id INTEGER NOT NULL,    product_name TEXT NOT NULL,    attempted_quantity INTEGER NOT NULL,    available_quantity INTEGER NOT NULL,    resolved INTEGER NOT NULL DEFAULT 0,    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,     updated_at DATETIME DEFAULT CURRENT_TIMESTAMP );
CREATE TABLE IF NOT EXISTS products ( id TEXT PRIMARY KEY DEFAULT (ABS(RANDOM()) % 1000000000000 + 100000000000), name TEXT COLLATE NOCASE NOT NULL, category TEXT COLLATE NOCASE NOT NULL, manufacturer TEXT COLLATE NOCASE, barcode TEXT UNIQUE COLLATE NOCASE, price REAL NOT NULL, tax REAL DEFAULT 0, tax_is_flat_rate INTEGER NOT NULL DEFAULT 0, quantity INTEGER NOT NULL, image_path TEXT, section TEXT,  shelf TEXT, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP, deleted_at DATETIME DEFAULT NULL);
CREATE TABLE IF NOT EXISTS sale_items ( id TEXT PRIMARY KEY DEFAULT (ABS(RANDOM()) % 1000000000000 + 100000000000), sale_id INTEGER NOT NULL, product_id INTEGER NOT NULL, quantity INTEGER NOT NULL, price REAL NOT NULL, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY (sale_id) REFERENCES sales(id) ON DELETE CASCADE, FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE);
CREATE TABLE IF NOT EXISTS sales ( id TEXT PRIMARY KEY DEFAULT (ABS(RANDOM()) % 1000000000000 + 100000000000), customer_id INTEGER DEFAULT NULL, date TEXT DEFAULT CURRENT_TIMESTAMP, subtotal REAL NOT NULL, tax REAL NOT NULL, discount REAL NOT NULL, total REAL NOT NULL, paid_amount REAL NOT NULL, change_amount REAL NOT NULL DEFAULT 0.0, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY (customer_id) REFERENCES customers(id) ON DELETE SET NULL);
CREATE TABLE IF NOT EXISTS saved_carts ( id TEXT PRIMARY KEY DEFAULT (ABS(RANDOM()) % 1000000000000 + 100000000000), customer_id INTEGER, items TEXT, status TEXT CHECK(status IN ('active', 'pending', 'completed', 'cancelled')) DEFAULT 'pending', created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP, FOREIGN KEY(customer_id) REFERENCES customers(id) ON DELETE CASCADE);
CREATE TABLE IF NOT EXISTS stocks ( id TEXT PRIMARY KEY DEFAULT (ABS(RANDOM()) % 1000000000000 + 100000000000), product_id INTEGER NOT NULL, supplier TEXT COLLATE NOCASE, supplier_contact TEXT COLLATE NOCASE, unit_price REAL NOT NULL, purchase_price REAL NOT NULL, purchase_date TEXT, expiry_date TEXT, quantity INTEGER NOT NULL, created_at DATETIME DEFAULT CURRENT_TIMESTAMP, updated_at DATETIME DEFAULT CURRENT_TIMESTAMP, deleted_at DATETIME DEFAULT NULL, FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE SET NULL);
CREATE TABLE IF NOT EXISTS product_discovery_tasks (id TEXT PRIMARY KEY DEFAULT (ABS(RANDOM()) % 1000000000000 + 100000000000), task_id TEXT UNIQUE NOT NULL COLLATE NOCASE, task_result TEXT, product_id INTEGER, stock_id INTEGER, status TEXT NOT NULL DEFAULT 'pending' CHECK(status IN ('pending', 'completed', 'cancelled')), created_at TEXT DEFAULT CURRENT_TIMESTAMP, updated_at TEXT DEFAULT CURRENT_TIMESTAMP, deleted_at TEXT DEFAULT NULL, FOREIGN KEY (product_id) REFERENCES products(id) ON DELETE CASCADE, FOREIGN KEY (stock_id) REFERENCES stocks(id) ON DELETE CASCADE);
CREATE TRIGGER IF NOT EXISTS set_paid_amount_default BEFORE INSERT ON sales FOR EACH ROW WHEN NEW.paid_amount IS NULL BEGIN     UPDATE sales SET paid_amount = NEW.total WHERE rowid = NEW.rowid; END;
CREATE TRIGGER IF NOT EXISTS update_customers_updated_at AFTER UPDATE ON customers FOR EACH ROW BEGIN    UPDATE customers SET updated_at = CURRENT_TIMESTAMP WHERE id = OLD.id; END;
CREATE TRIGGER IF NOT EXISTS update_out_of_stock_log_updated_at AFTER UPDATE ON out_of_stock_log FOR EACH ROW BEGIN    UPDATE out_of_stock_log SET updated_at = CURRENT_TIMESTAMP WHERE id = OLD.id; END;
CREATE TRIGGER IF NOT EXISTS update_products_updated_at AFTER UPDATE ON products FOR EACH ROW BEGIN    UPDATE products SET updated_at = CURRENT_TIMESTAMP WHERE id = OLD.id; END;
CREATE TRIGGER IF NOT EXISTS update_sale_items_updated_at AFTER UPDATE ON sale_items FOR EACH ROW BEGIN    UPDATE sale_items SET updated_at = CURRENT_TIMESTAMP WHERE id = OLD.id; END;
CREATE TRIGGER IF NOT EXISTS update_sales_updated_at AFTER UPDATE ON sales FOR EACH ROW BEGIN    UPDATE sales SET updated_at = CURRENT_TIMESTAMP WHERE id = OLD.id; END;
CREATE TRIGGER IF NOT EXISTS update_saved_carts_updated_at AFTER UPDATE ON saved_carts FOR EACH ROW BEGIN    UPDATE saved_carts SET updated_at = CURRENT_TIMESTAMP WHERE id = OLD.id; END;
CREATE TRIGGER IF NOT EXISTS update_stocks_updated_at AFTER UPDATE ON stocks FOR EACH ROW BEGIN    UPDATE stocks SET updated_at = CURRENT_TIMESTAMP WHERE id = OLD.id; END;
CREATE TRIGGER IF NOT EXISTS update_product_discovery_tasks_updated_at AFTER UPDATE ON product_discovery_tasks FOR EACH ROW BEGIN    UPDATE product_discovery_tasks SET updated_at = CURRENT_TIMESTAMP WHERE id = OLD.id; END;
COMMIT;
